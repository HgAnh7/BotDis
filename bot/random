import random
import discord
from pathlib import Path
from discord.ext import commands

# Danh sách các kênh được phép sử dụng lệnh
ALLOWED_CHANNELS = [
    1375707188252901376,  # Thay bằng ID của kênh thực tế
    1375707367051886654,
]

# Kênh gửi thông báo lỗi
ERROR_CHANNEL_ID = 1377693583741812867

# Hàm load danh sách URL từ file
def load_images(file_path: Path):
    try:
        with file_path.open("r", encoding="utf-8") as file:
            images = [line.strip() for line in file if line.strip()]
        return images
    except Exception as e:
        print(f"[Load Images] Lỗi khi đọc file {file_path}: {e}")
        return []

# Cache danh sách URL khi bot khởi động
COSPLAY_FILE_PATH = Path("bot/url/cosplay")
COSPLAY_IMAGES = load_images(COSPLAY_FILE_PATH)

GIRLSEXY_FILE_PATH = Path("bot/url/girlsexy")
GIRLSEXY_IMAGES = load_images(GIRLSEXY_FILE_PATH)

def register_cosplay(bot: commands.Bot):
    @bot.tree.command(name="cosplay", description="Gửi ảnh cosplay ngẫu nhiên (only: 🔞┊nsfw)")
    async def cosplay(interaction: discord.Interaction):
        if interaction.channel_id not in ALLOWED_CHANNELS:
            await interaction.response.send_message(
                "❌ Lệnh này chỉ có thể sử dụng trong các kênh được chỉ định!",
                ephemeral=True
            )
            return

        if not COSPLAY_IMAGES:
            error_message = "Danh sách ảnh chưa được tải hoặc trống."
            error_channel = bot.get_channel(ERROR_CHANNEL_ID)
            if error_channel:
                await error_channel.send(f"❌ [Cosplay] {error_message}")
            await interaction.response.send_message("❌ Lỗi: Danh sách ảnh không tồn tại.", ephemeral=True)
            return

        try:
            selected_image = random.choice(COSPLAY_IMAGES)
            embed = discord.Embed(title="Cosplay Ngẫu Nhiên")
            embed.set_image(url=selected_image)
            await interaction.response.send_message(embed=embed)
        except Exception as e:
            error_channel = bot.get_channel(ERROR_CHANNEL_ID)
            if error_channel:
                await error_channel.send(f"❌ [Cosplay] Lỗi: {e}")
            await interaction.response.send_message(
                "❌ Đã có lỗi xảy ra. Vui lòng thử lại sau.",
                ephemeral=True
            )

def register_girlsexy(bot: commands.Bot):
    @bot.tree.command(name="girlsexy", description="Gửi ảnh gái sexy ngẫu nhiên (only: 🔞┊nsfw)")
    async def girlsexy(interaction: discord.Interaction):
        if interaction.channel_id not in ALLOWED_CHANNELS:
            await interaction.response.send_message(
                "❌ Lệnh này chỉ có thể sử dụng trong các kênh được chỉ định!",
                ephemeral=True
            )
            return

        if not GIRLSEXY_IMAGES:
            error_message = "Danh sách ảnh chưa được tải hoặc trống."
            error_channel = bot.get_channel(ERROR_CHANNEL_ID)
            if error_channel:
                await error_channel.send(f"❌ [Manga] {error_message}")
            await interaction.response.send_message("❌ Lỗi: Danh sách ảnh không tồn tại.", ephemeral=True)
            return

        try:
            selected_image = random.choice(GIRLSEXY_IMAGES)
            embed = discord.Embed(title="Gái Sexy Ngẫu Nhiên")
            embed.set_image(url=selected_image)
            await interaction.response.send_message(embed=embed)
        except Exception as e:
            error_channel = bot.get_channel(ERROR_CHANNEL_ID)
            if error_channel:
                await error_channel.send(f"❌ [Girlsexy] Lỗi: {e}")
            await interaction.response.send_message(
                "❌ Đã có lỗi xảy ra. Vui lòng thử lại sau.",
                ephemeral=True
            )