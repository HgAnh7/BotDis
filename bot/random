import random
import discord
from pathlib import Path
from discord.ext import commands

# Configuration
ALLOWED_CHANNELS = [1375707188252901376, 1375707367051886654]
ERROR_CHANNEL_ID = 1377693583741812867

# Command definitions
COMMANDS = {
    "nude": ["Nude Ngáº«u NhiÃªn", "Gá»­i áº£nh nude ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "butt": ["Butt Ngáº«u NhiÃªn", "Gá»­i áº£nh butt ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "pussy": ["Pussy Ngáº«u NhiÃªn", "Gá»­i áº£nh pussy ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "cosplay": ["Cosplay Ngáº«u NhiÃªn", "Gá»­i áº£nh cosplay ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "anime": ["Anime Ngáº«u NhiÃªn", "Gá»­i áº£nh anime ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "girlsexy": ["GÃ¡i Sexy Ngáº«u NhiÃªn", "Gá»­i áº£nh gÃ¡i sexy ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"],
    "breastsqueeze": ["Breastsqueeze Ngáº«u NhiÃªn", "Gá»­i áº£nh breastsqueeze ngáº«u nhiÃªn (only: ğŸ”â”Šnsfw)"]
}

# Load all images with error handling
def load_all_images():
    collections = {}
    for cmd in COMMANDS:
        try:
            file_path = Path(f"bot/url/{cmd}")
            collections[cmd] = [line.strip() for line in file_path.read_text(encoding="utf-8").splitlines() if line.strip()] if file_path.exists() else []
        except Exception as e:
            print(f"[Load Images] Lá»—i khi Ä‘á»c file {cmd}: {e}")
            collections[cmd] = []
    return collections

IMAGE_COLLECTIONS = load_all_images()

async def send_random_image(interaction: discord.Interaction, bot: commands.Bot, cmd: str):
    if interaction.channel_id not in ALLOWED_CHANNELS:
        return await interaction.response.send_message(
            "âŒ Lá»‡nh nÃ y chá»‰ cÃ³ thá»ƒ sá»­ dá»¥ng trong cÃ¡c kÃªnh Ä‘Æ°á»£c chá»‰ Ä‘á»‹nh!", ephemeral=True)
    
    if not (images := IMAGE_COLLECTIONS[cmd]):
        if error_channel := bot.get_channel(ERROR_CHANNEL_ID):
            await error_channel.send(f"âŒ [{cmd.title()}] Danh sÃ¡ch áº£nh chÆ°a Ä‘Æ°á»£c táº£i hoáº·c trá»‘ng.")
        return await interaction.response.send_message("âŒ Lá»—i: Danh sÃ¡ch áº£nh khÃ´ng tá»“n táº¡i.", ephemeral=True)
    
    try:
        embed = discord.Embed(title=COMMANDS[cmd][0])
        embed.set_image(url=random.choice(images))
        await interaction.response.send_message(embed=embed)
    except Exception as e:
        if error_channel := bot.get_channel(ERROR_CHANNEL_ID):
            await error_channel.send(f"âŒ [{cmd.title()}] Lá»—i: {e}")
        await interaction.response.send_message("âŒ ÄÃ£ cÃ³ lá»—i xáº£y ra. Vui lÃ²ng thá»­ láº¡i sau.", ephemeral=True)

def register_all_commands(bot: commands.Bot):
    """Register all commands dynamically"""
    for cmd, (title, desc) in COMMANDS.items():
        # Fix closure issue with lambda and default parameter
        def create_command(cmd_name=cmd):
            async def image_command(interaction: discord.Interaction):
                await send_random_image(interaction, bot, cmd_name)
            return image_command
        
        bot.tree.command(name=cmd, description=desc)(create_command())

# Convenience functions - chá»‰ cáº§n gá»i 1 láº§n register_all_commands()
register_nude = register_butt = register_pussy = register_cosplay = register_anime = register_girlsexy = register_breastsqueeze = register_all_commands